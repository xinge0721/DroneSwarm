# 无人机初号机验证方案（清晰版）—— 优先稳定性+预留PID调试串口
## 核心目标
以“验证GPS+上位机ROS控制+PID调试”为核心，预算200-300元，硬件选稳定款，明确各模块职责与数据流，避免混乱，后续可低成本复刻。


## 一、初号机硬件清单（总成本282元，含PID调试串口）
| 模块         | 型号规格                | 成本（元） | 核心作用                          | 串口/引脚分配（ESP32-S3）          |
|--------------|-------------------------|------------|-----------------------------------|-----------------------------------|
| **主控制器** | ESP32-S3-DevKitC-1（8MB Flash） | 35         | 核心中枢，4个硬件UART满足多串口需求 | 总控所有模块，分配3个UART（留1个备用） |
| **姿态传感器** | JY60（6轴IMU，串口输出） | 30         | 高精度姿态采集（100Hz，比MPU6050稳定） | 接UART2：GPIO16（RX）、GPIO17（TX） |
| **GPS模块**  | Ublox M8N（带陶瓷天线） | 37         | 室外1米级定位（支持GPS+北斗，10Hz更新） | 接UART1：GPIO10（RX）、GPIO11（TX） |
| **PID调试串口** | 预留UART0（原生USB转串口） | 0（ESP32自带） | 实时修改PID参数（无需额外硬件） | UART0：GPIO3（RX）、GPIO1（TX）→ 接电脑USB |
| **动力系统** | 空心杯电机8520（KV10000，4个） | 28（7元/个） | 提供升力，适配初号机重量 | PWM引脚：GPIO4（前左）、GPIO5（前右）、GPIO6（后左）、GPIO7（后右） |
|              | 微型电调（3.7V 8A，4个） | 40（10元/个） | 驱动电机，带5V稳压给ESP32供电 | 电调信号端接上述PWM引脚，电源端接电池 |
| **电池**     | 3.7V 1000mAh（30C放电，带保护板） | 35         | 续航12-15分钟，比500mAh更稳定 | 2Pin PH座接电调电源输入 |
| **机架**     | 120mm碳纤维空心杯机架（带电机座） | 30         | 轻量化（22g）+高强度，避免炸机损坏 | 固定所有模块，重心居中 |
| **显示与指示** | 0.96英寸OLED（软件IIC） | 10         | 实时显示姿态/GPS状态（调试用） | GPIO21（SDA）、GPIO22（SCL） |
| **辅助配件** | 杜邦线（公对母/母对母）、热缩管、端子 | 17         | 接线固定，减少接触不良 | - |
| **总计**     | -                       | **282元**  | 控制在预算内，稳定性拉满          | -                                 |


## 二、关键设计：串口分配（核心解决“留PID调试口”需求）
ESP32-S3有4个硬件UART，明确用途不冲突，重点留足PID调试口：
| UART编号 | 用途                | 连接设备/场景          | 波特率  | 核心价值                          |
|----------|---------------------|------------------------|---------|-----------------------------------|
| UART0    | PID调试专用         | 接电脑USB（通过ESP32原生USB转串口） | 115200  | 实时修改PID参数（如P=2.0→3.0），无需重启固件 |
| UART1    | GPS数据接收         | Ublox M8N              | 9600    | 接收10Hz高精度GPS数据（经纬度/卫星数） |
| UART2    | 姿态数据接收        | JY60                   | 115200  | 接收100Hz姿态数据（roll/pitch/yaw），无IIC冲突 |
| UART3    | 备用                | 后期扩展（如数传模块） | -       | 为多机协同预留通信口，暂不使用    |

> 注：PID调试串口用ESP32自带的USB转UART（UART0），无需额外加串口模块，插电脑USB即可通过串口助手（如SSCOM）发送参数指令。


## 三、三层核心逻辑（无人机端→通信→上位机ROS）
### 1. 无人机端（ESP32固件，C/Arduino实现）
#### 核心功能：
- **多串口数据处理**：
  - UART0（PID调试）：接收电脑发来的PID参数指令（如“P1=2.5,P2=0.3”），实时更新PID系数；
  - UART1（GPS）：解析M8N的NMEA协议（取`$GNRMC`语句），提取经纬度、卫星数；
  - UART2（JY60）：读取姿态数据，做滑动滤波（去除噪声）。
- **数据打包发送**：将“姿态+GPS+电池电压+PID参数”整合成JSON，通过WiFi-UDP发往上位机（50Hz频率），示例：
  ```json
  {
    "drone_id": "test_01",
    "roll": 1.1, "pitch": 0.8, "yaw": 359.2,  // JY60数据
    "lat": 30.123456, "lon": 120.654321,      // M8N数据
    "sat": 13, "batt": 3.85,                  // 卫星数、电池电压
    "pid_p": 2.5, "pid_i": 0.3, "pid_d": 0.8  // 当前PID参数
  }
  ```
- **控制指令执行**：接收上位机的“期望姿态指令”（roll/pitch/throttle），通过PID计算输出4路PWM，驱动电机。


### 2. 通信层（WiFi-UDP）
- 无人机端：ESP32连接电脑热点（如“drone_test”），固定IP（192.168.1.101）；
- 上位机端：笔记本通过同一热点，与ESP32建立UDP连接，确保数据延迟<100ms（满足控制需求）。


### 3. 上位机ROS功能包（仅笔记本运行，4个包无重叠）
| ROS功能包          | 核心作用                          | 关键话题/指令                          |
|---------------------|-----------------------------------|----------------------------------------|
| **udp_ros_bridge**  | 通信桥梁：UDP↔ROS话题转换         | 接收：无人机JSON数据→发布`/test_01/imu`（姿态）、`/test_01/gps`（GPS）；<br>发送：订阅`/test_01/cmd_vel`（控制指令）→ 转UDP给ESP32 |
| **drone_data_proc** | 数据处理：GPS坐标转换+状态监控    | 1. 经纬度→UTM平面坐标（发布`/test_01/utm_pose`，便于计算距离）；<br>2. 低电量（<3.5V）、GPS弱信号（<6颗星）→ 发布`/drone_alarm`报警 |
| **drone_planner**   | 规划与控制：生成路径+位置PID      | 1. 手动输入目标UTM坐标→生成直线路径（发布`/test_01/path`）；<br>2. 位置偏差→计算期望姿态（发布`/test_01/cmd_vel`） |
| **drone_monitor**   | 可视化与调试：RViz显示+日志记录   | 1. RViz显示：GPS位置（红色圆点）、路径（蓝色线）、PID参数（文本）；<br>2. 录制`/test_01/gps`、`/test_01/cmd_vel`为.bag文件，供后期分析 |


## 四、验证步骤（从单模块到系统联调，避免混乱）
###  Step 1：硬件单独测试（确保每个模块能用）
1. **串口测试**：用电脑USB接ESP32的UART0（PID调试口），通过串口助手发送指令，确认ESP32能接收并回复（验证调试串口正常）；
2. **GPS测试**：室外放置M8N，用串口助手读UART1数据，确认卫星数≥6，经纬度稳定（误差<2米）；
3. **姿态测试**：接JY60到UART2，晃动无人机，确认姿态数据连续变化（无跳变）；
4. **电机测试**：给电调供电，通过ESP32输出PWM，确认4个电机转速可调（0-100%），对角转向相反。

###  Step 2：固件调试（无人机端核心逻辑）
1. 先实现“单模块+OLED显示”：比如JY60姿态在OLED实时刷新，GPS卫星数显示；
2. 加入WiFi通信：确保上位机能收到完整JSON数据（用网络调试助手验证）；
3. 调试PID串口：通过UART0发送“PID_P=2.5”，确认OLED能显示新参数（实时生效）。

###  Step 3：ROS联调（上位机控制逻辑）
1. 启动`udp_ros_bridge`：在RViz中添加`/test_01/gps`话题，看到红色圆点跟随无人机移动；
2. 启动`drone_planner`：输入目标UTM坐标（比如当前坐标+3米），看到`/test_01/path`显示直线路径；
3. 地面测试：无人机放在地面，发送控制指令，确认电机能根据GPS偏差调整转速（比如偏向目标方向时，对应电机加速）。

###  Step 4：试飞验证（低空小范围测试）
1. 室外无遮挡环境，低空悬停（1米高），观察姿态是否稳定（PID参数不合适则微调UART0的参数）；
2. 简单路径跟踪：控制无人机从A点飞到3米外B点，确认能大致按规划路径飞行，GPS定位准确。


## 五、后续优化方向
1. **压成本**：验证通过后，可将JY60（30元）换为MPU6050（10元）、M8N（37元）换为NEO-6M（20元），单架成本可降至200元内；
2. **多机扩展**：新增无人机时，只需修改`drone_id`和IP，ROS功能包无需重构（复用`udp_ros_bridge`和`drone_planner`）；
3. **功能升级**：UART3可接光流模块（室内定位），解决GPS室内失效问题。


## 核心总结
整个方案围绕“清晰、可验证”设计：硬件上明确串口分配（重点留PID调试口），固件上聚焦“采集+执行”，ROS上专注“处理+规划”，数据流从无人机→WiFi→上位机无断点，用户可按步骤逐步验证，避免混乱。预算282元满足稳定性需求，后续压成本空间充足，完全适配“先验证再量产”的思路。