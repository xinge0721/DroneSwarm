# 无人机技术路线规划 —— ESP32无人机系统设计

## 核心目标
基于ESP32开发无人机控制系统，重点实现GPS定位、姿态控制和上位机ROS通信，明确各模块职责与数据流，构建可扩展的无人机平台。


## 一、ESP32-S3硬件资源分析与分配

### 硬件资源概况
| 资源类型 | 数量 | 用途分配 |
|----------|------|----------|
| **定时器组** | 4个定时器 | Timer1.0(系统心跳1Hz), Timer0.0/0.1/1.1(备用) |
| **LEDC PWM** | 8通道 | 4通道电机PWM(20kHz) + 4通道备用 |
| **UART** | 3个 | UART0(USB调试), UART1(GPS), UART2(备用扩展) |
| **I2C** | 2个控制器 | I2C0(MPU6050), I2C1(OLED显示) |
| **USB OTG** | 1个 | 原生USB调试接口 |
| **GPIO** | 45个可用 | 4个PWM + 7个I2C/UART/INT + 4个指示 + 1个ADC + 29个备用 |

### 硬件模块配置
| 模块 | 型号规格 | 核心作用 | 接口分配 | 资源使用 |
|------|----------|----------|----------|----------|
| **主控制器** | ESP32-S3-DevKitC-1 | 核心控制器，240MHz双核 | - | 外部中断驱动控制任务 |
| **姿态传感器** | MPU6050（I2C接口） | 姿态数据采集 | I2C0: GPIO8(SDA), GPIO9(SCL), GPIO6(INT) | MPU6050数据就绪中断驱动控制循环(100Hz) |
| **GPS模块** | NEO-6M | 室外定位 | UART1: GPIO17(RX), GPIO18(TX) | 异步串口接收 |
| **动力系统** | 空心杯电机8520×4 | 四轴升力提供 | LEDC PWM: GPIO1,2,3,4 | LEDC Ch0-3 (20kHz PWM) |
| | 微型电调×4 | 电机驱动 | 连接上述PWM引脚 | - |
| **电池系统** | 3.7V 1000mAh锂电池 | 系统供电 | ADC1(GPIO5电压检测) | 在主控制循环中采样 |
| **显示模块** | 0.96"OLED | 状态显示 | I2C1: GPIO21(SDA), GPIO22(SCL) | 在主控制循环中更新(10Hz) |
| **指示系统** | 状态LED | 飞行状态指示 | GPIO10(红), GPIO11(绿) | 普通GPIO输出 |
| | 蜂鸣器 | 报警提示 | GPIO12 | 普通GPIO输出(高低电平控制) |
| **调试接口** | USB OTG | 参数调试和数据记录 | 原生USB接口 | Timer1.0(系统心跳1Hz) |
| **扩展接口** | 预留UART2 | 数传/遥控器 | GPIO15(RX), GPIO16(TX) | 需要时启用 |


## 二、系统架构设计

### 主控制循环（100Hz外部中断驱动）
```
MPU6050数据就绪中断 → 控制任务唤醒 (每10ms执行一次):
├── 1. 读取MPU6050数据 (I2C, ~1ms) [保证新数据]
├── 2. 卡尔曼滤波处理姿态数据 (~0.5ms)  
├── 3. PID控制计算 (期望姿态 vs 当前姿态, ~0.5ms)
├── 4. 更新电机PWM输出 (~0.2ms)
├── 5. 电池电压采样 (每10次执行1次, ~0.1ms)
├── 6. OLED显示更新 (每10次执行1次, ~1ms)
└── 7. WiFi数据发送 (每2次执行1次, 50Hz数据流)
总耗时: ~3-4ms，节省1个定时器资源，数据同步更精确
```

### 通信接口配置

#### 标准配置（MPU6050 + NEO-6M）
| 接口类型 | 用途 | 连接设备 | 配置参数 | 处理方式 |
|----------|------|----------|----------|----------|
| USB OTG | 参数调试 | 电脑USB口 | 115200 | 原生USB，实时修改PID参数 |
| UART1 | GPS数据 | NEO-6M | 9600 | 串口中断接收，主循环解析 |
| I2C0 | 姿态传感器 | MPU6050 | 400kHz | 定时器中断中读取 |
| I2C1 | 显示屏 | OLED | 400kHz | 定时器中断中更新(10Hz) |
| UART2 | 扩展接口 | 数传/遥控器 | 可配置 | 需要时启用 |

#### 初号机配置（JY60 + NEO-M8N）  
| 接口类型 | 用途 | 连接设备 | 配置参数 | 处理方式 |
|----------|------|----------|----------|----------|
| USB OTG | 参数调试 | 电脑USB口 | 115200 | 原生USB调试 |
| UART1 | GPS数据 | NEO-M8N | 9600 | 串口中断接收 |
| UART2 | 姿态传感器 | JY60 | 9600 | 串口中断接收 |
| I2C1 | 显示屏 | OLED | 400kHz | 定时器中断更新 |

### 资源优化设计要点

#### 1. 定时器资源节约
- **合并控制循环**：PID控制、卡尔曼滤波、状态更新合并到单个100Hz定时器中断
- **时间片管理**：在10ms时间片内，按优先级顺序执行各任务，总耗时控制在4ms内
- **分频处理**：电池电压和OLED更新采用分频方式，降低处理频率

#### 2. PWM资源节约  
- **电机专用**：4个LEDC PWM通道专门用于电机控制(20kHz)
- **蜂鸣器简化**：报警蜂鸣器使用普通GPIO高低电平控制，无需占用PWM资源

#### 3. I2C总线分离
- **避免冲突**：MPU6050和OLED分别使用不同I2C控制器，避免地址冲突和时序问题
- **并行处理**：两个I2C总线可以并行工作，提高系统响应速度

#### 4. 调试接口优化
- **原生USB**：使用ESP32-S3原生USB接口进行调试，无需占用UART资源
- **实时参数调整**：通过USB接口实时修改PID参数，便于调试和优化


## 三、三层核心逻辑（无人机端→通信→上位机ROS）
### 1. 无人机端（ESP32固件，C/Arduino实现）
#### 核心功能：
- **多串口数据处理**：
  - UART0（PID调试）：接收电脑发来的PID参数指令（如“P1=2.5,P2=0.3”），实时更新PID系数；
  - UART1（GPS）：解析M8N的NMEA协议（取`$GNRMC`语句），提取经纬度、卫星数；
  - UART2（JY60）：读取姿态数据，做滑动滤波（去除噪声）。
- **数据打包发送**：将“姿态+GPS+电池电压+PID参数”整合成JSON，通过WiFi-UDP发往上位机（50Hz频率），示例：
  ```json
  {
    "drone_id": "test_01",
    "roll": 1.1, "pitch": 0.8, "yaw": 359.2,  // JY60数据
    "lat": 30.123456, "lon": 120.654321,      // M8N数据
    "sat": 13, "batt": 3.85,                  // 卫星数、电池电压
    "pid_p": 2.5, "pid_i": 0.3, "pid_d": 0.8  // 当前PID参数
  }
  ```
- **控制指令执行**：接收上位机的“期望姿态指令”（roll/pitch/throttle），通过PID计算输出4路PWM，驱动电机。


### 2. 通信层（WiFi-UDP）
- 无人机端：ESP32连接电脑热点（如“drone_test”），固定IP（192.168.1.101）；
- 上位机端：笔记本通过同一热点，与ESP32建立UDP连接，确保数据延迟<100ms（满足控制需求）。


### 3. 上位机ROS功能包（仅笔记本运行，4个包无重叠）
| ROS功能包          | 核心作用                          | 关键话题/指令                          |
|---------------------|-----------------------------------|----------------------------------------|
| **udp_ros_bridge**  | 通信桥梁：UDP↔ROS话题转换         | 接收：无人机JSON数据→发布`/test_01/imu`（姿态）、`/test_01/gps`（GPS）；<br>发送：订阅`/test_01/cmd_vel`（控制指令）→ 转UDP给ESP32 |
| **drone_data_proc** | 数据处理：GPS坐标转换+状态监控    | 1. 经纬度→UTM平面坐标（发布`/test_01/utm_pose`，便于计算距离）；<br>2. 低电量（<3.5V）、GPS弱信号（<6颗星）→ 发布`/drone_alarm`报警 |
| **drone_planner**   | 规划与控制：生成路径+位置PID      | 1. 手动输入目标UTM坐标→生成直线路径（发布`/test_01/path`）；<br>2. 位置偏差→计算期望姿态（发布`/test_01/cmd_vel`） |
| **drone_monitor**   | 可视化与调试：RViz显示+日志记录   | 1. RViz显示：GPS位置（红色圆点）、路径（蓝色线）、PID参数（文本）；<br>2. 录制`/test_01/gps`、`/test_01/cmd_vel`为.bag文件，供后期分析 |


## 四、验证步骤（从单模块到系统联调，避免混乱）
###  Step 1：硬件单独测试（确保每个模块能用）
1. **串口测试**：用电脑USB接ESP32的UART0（PID调试口），通过串口助手发送指令，确认ESP32能接收并回复（验证调试串口正常）；
2. **GPS测试**：室外放置M8N，用串口助手读UART1数据，确认卫星数≥6，经纬度稳定（误差<2米）；
3. **姿态测试**：接JY60到UART2，晃动无人机，确认姿态数据连续变化（无跳变）；
4. **电机测试**：给电调供电，通过ESP32输出PWM，确认4个电机转速可调（0-100%），对角转向相反。

###  Step 2：固件调试（无人机端核心逻辑）
1. 先实现“单模块+OLED显示”：比如JY60姿态在OLED实时刷新，GPS卫星数显示；
2. 加入WiFi通信：确保上位机能收到完整JSON数据（用网络调试助手验证）；
3. 调试PID串口：通过UART0发送“PID_P=2.5”，确认OLED能显示新参数（实时生效）。

###  Step 3：ROS联调（上位机控制逻辑）
1. 启动`udp_ros_bridge`：在RViz中添加`/test_01/gps`话题，看到红色圆点跟随无人机移动；
2. 启动`drone_planner`：输入目标UTM坐标（比如当前坐标+3米），看到`/test_01/path`显示直线路径；
3. 地面测试：无人机放在地面，发送控制指令，确认电机能根据GPS偏差调整转速（比如偏向目标方向时，对应电机加速）。

###  Step 4：试飞验证（低空小范围测试）
1. 室外无遮挡环境，低空悬停（1米高），观察姿态是否稳定（PID参数不合适则微调UART0的参数）；
2. 简单路径跟踪：控制无人机从A点飞到3米外B点，确认能大致按规划路径飞行，GPS定位准确。


## 五、后续优化方向
1. **硬件优化**：系统验证稳定后，可考虑使用MPU6050替代JY60，NEO-6M替代NEO-M8N，进一步降低系统成本；
2. **多机扩展**：新增无人机时，只需修改`drone_id`和IP，ROS功能包无需重构（复用`udp_ros_bridge`和`drone_planner`）；
3. **功能升级**：UART3可接光流模块（室内定位），解决GPS室内失效问题。


## 核心总结
整个方案基于ESP32构建无人机控制系统，硬件上明确通信接口分配（重点预留PID调试接口），固件上聚焦"数据采集+控制执行"，ROS上专注"数据处理+路径规划"，数据流从无人机→WiFi→上位机形成完整闭环，用户可按步骤逐步验证各模块功能，确保系统稳定可靠。